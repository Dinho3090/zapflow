# ─────────────────────────────────────────────────────────
# ZapFlow — Nginx Reverse Proxy
# arquivo: nginx/nginx.conf
# ─────────────────────────────────────────────────────────
user  nginx;
worker_processes auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
  worker_connections 2048;
  multi_accept on;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # ── Segurança ───────────────────────────────────────────
  server_tokens          off;
  add_header X-Frame-Options              SAMEORIGIN;
  add_header X-Content-Type-Options       nosniff;
  add_header X-XSS-Protection             "1; mode=block";
  add_header Referrer-Policy              "strict-origin-when-cross-origin";
  add_header Permissions-Policy           "camera=(), microphone=(), geolocation=()";

  # ── Performance ─────────────────────────────────────────
  sendfile           on;
  tcp_nopush         on;
  tcp_nodelay        on;
  keepalive_timeout  65;
  types_hash_max_size 2048;
  client_max_body_size 70M;        # Suporta upload de vídeos até 64MB

  # ── Gzip ────────────────────────────────────────────────
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types text/plain text/css application/json application/javascript
             text/xml application/xml application/xml+rss text/javascript;

  # ── Logs ────────────────────────────────────────────────
  log_format  main  '$remote_addr - [$time_local] "$request" $status '
                    '$body_bytes_sent "$http_referer" "$http_user_agent"';
  access_log  /var/log/nginx/access.log main;

  # ── Rate limiting (anti-spam / DDoS) ───────────────────
  limit_req_zone  $binary_remote_addr zone=api:10m    rate=30r/m;
  limit_req_zone  $binary_remote_addr zone=webhook:10m rate=120r/m;

  # ── HTTP → HTTPS redirect ────────────────────────────────
  server {
    listen 80;
    server_name _;

    # Certbot challenge (antes do redirect)
    location /.well-known/acme-challenge/ {
      root /var/www/certbot;
    }

    location / {
      return 301 https://$host$request_uri;
    }
  }

  # ── FRONTEND (app.seudominio.com) ────────────────────────
  server {
    listen 443 ssl http2;
    server_name app.magsistem.com.br;

    ssl_certificate     /etc/letsencrypt/live/app.magsistem.com.br/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.magsistem.com.br/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:SSL:10m;

    location / {
      proxy_pass         http://zf_frontend:3000;
      proxy_http_version 1.1;
      proxy_set_header   Upgrade           $http_upgrade;
      proxy_set_header   Connection        'upgrade';
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
      proxy_cache_bypass $http_upgrade;
    }
  }

  # ── BACKEND API (api.seudominio.com) ─────────────────────
  server {
    listen 443 ssl http2;
    server_name api.magsistem.com.br;

    ssl_certificate     /etc/letsencrypt/live/api.magsistem.com.br/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.magsistem.com.br/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # Rate limit para rotas de API normais
    location /api/ {
      limit_req zone=api burst=20 nodelay;
      proxy_pass         http://zf_backend:3001;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
      proxy_read_timeout 300s;      # Para uploads grandes
      client_max_body_size 70M;
    }

    # Webhook (limite maior — Evolution chama com frequência)
    location /webhook/ {
      limit_req zone=webhook burst=50 nodelay;
      proxy_pass         http://zf_backend:3001;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
    }

    # Admin (sem rate limit — uso interno)
    location /admin/ {
      proxy_pass         http://zf_backend:3001;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
    }

    location /health {
      proxy_pass http://zf_backend:3001;
    }
  }

  # ── ADMIN PANEL (admin.seudominio.com) ───────────────────
  server {
    listen 443 http2;
    server_name admin.magsistem.com.br;

    ssl_certificate     /etc/letsencrypt/live/admin.magsistem.com.br/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.magsistem.com.br/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # Bloqueia acesso de IPs externos (só seu IP)
    # Descomente e troque pelo seu IP fixo:
    # allow  SEU_IP_AQUI;
    # deny   all;

    location / {
      proxy_pass         http://zf_admin:3002;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
    }
  }
}
