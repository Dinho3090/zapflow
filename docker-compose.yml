version: '3.8'

services:
  # --- MOTOR DE WHATSAPP (Evolution) ---
  evolution:
    image: atendai/evolution-api:latest
    container_name: zf_evolution
    restart: always
    ports: ["8080:8080"]
    environment:
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - SERVER_URL=http://${DOMAIN}:8080
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://${EVOL_DB_USER}:${EVOL_DB_PASS}@zf_postgres:5432/evolution?sslmode=disable
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://zf_redis:6379
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://zf_backend:3001/webhook/evolution
    volumes:
      - evolution_data:/evolution/instances
    depends_on:
      - zf_postgres
      - zf_redis
    networks:
      - zf_net

  # --- BANCO DE DATOS (Postgres) ---
  zf_postgres:
    image: postgres:15-alpine
    container_name: zf_postgres
    restart: always
    environment:
      POSTGRES_USER: ${EVOL_DB_USER}
      POSTGRES_PASSWORD: ${EVOL_DB_PASS}
      POSTGRES_DB: evolution
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - zf_net

  # --- CACHE (Redis) ---
  zf_redis:
    image: redis:7-alpine
    container_name: zf_redis
    restart: always
    networks:
      - zf_net

  # --- BACKEND (Onde o Mimetismo Humano acontece) ---
  zf_backend:
    build:
      context: ./backend
      dockerfile: Dockerfile # Mudamos de Dockerfile.backend para Dockerfile
    container_name: zf_backend
    restart: always
    ports: ["3001:3001"]
    env_file: .env # Ele vai ler as chaves que preenchemos no arquivo .env
    depends_on:
      - zf_redis
      - evolution
    networks:
      - zf_net

  # --- FRONTEND (Dashboard do Usuário) ---
  zf_frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile # Mudamos de Dockerfile.frontend para Dockerfile
    container_name: zf_frontend
    restart: always
    ports: ["3000:3000"]
    env_file: .env
    depends_on:
      - zf_backend
    networks:
      - zf_net

  # --- ADMIN (Validação de HWID e Licenças) ---
  zf_admin:
    build:
      context: ./admin
      dockerfile: Dockerfile # Agora ele builda a pasta local que criamos
    container_name: zf_admin
    restart: always
    ports: ["3002:3002"]
    env_file: .env
    networks:
      - zf_net

  # --- SERVIDOR WEB (Nginx) ---
  zf_nginx:
    image: nginx:stable-alpine
    container_name: zf_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro  
    networks:
      - zf_net

networks:
  zf_net:
    driver: bridge

volumes:
  redis_data:
  evolution_data:
  postgres_data: